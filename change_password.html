<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trocar Senha — Vizô Admin</title>
    <style>
        :root { --primary:#2e70ce; --secondary:#0b2447; --bg:#f3f4f6; --card:#fff; --text:#1f2937; --border:#e5e7eb; --gray:#6b7280;}
        *{box-sizing:border-box} body{margin:0;padding:0;background:var(--bg);display:flex;align-items:center;justify-content:center;height:100vh;font-family:'Segoe UI',system-ui,sans-serif;color:var(--text)}
        .card{width:100%;max-width:420px;background:var(--card);padding:2rem;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
        .logo{text-align:center;margin-bottom:14px}.logo img{max-width:108px;height:auto}
        h1{margin:0 0 6px 0;color:var(--secondary);font-size:1.3rem;text-align:center}
        p{margin:0 0 18px 0;color:var(--gray);font-size:.95rem;text-align:center}
        label{display:block;font-weight:600;margin:10px 0 6px}
        input{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:10px;outline:none;font-size:1rem}
        input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(46,112,206,.1)}
        .btn{width:100%;padding:.8rem;background:var(--primary);color:#fff;border:0;border-radius:10px;font-weight:700;cursor:pointer;margin-top:14px}
        .error{color:#ef4444;font-size:.9rem;display:none;margin-top:8px;text-align:center}
        .success{color:#10b981;font-size:.95rem;display:none;margin-top:8px;text-align:center}
        .link{display:block;margin-top:12px;text-align:center;color:var(--primary);text-decoration:none}
    </style>
    <script>
        async function submitChange() {
            const email = sessionStorage.getItem('vizô_user') || '';
            const current_password = document.getElementById('current').value;
            const new_password = document.getElementById('new').value;
            const confirm_password = document.getElementById('confirm').value;
            const err = document.getElementById('err'); const ok = document.getElementById('ok');
            err.style.display='none'; ok.style.display='none';
            if(!email){ err.textContent='Sessão inválida. Faça login novamente.'; err.style.display='block'; return; }
            if(!current_password||!new_password||!confirm_password){ err.textContent='Preencha todos os campos.'; err.style.display='block'; return; }
            if(new_password.length<8){ err.textContent='A nova senha deve ter pelo menos 8 caracteres.'; err.style.display='block'; return; }
            if(new_password!==confirm_password){ err.textContent='As senhas não conferem.'; err.style.display='block'; return; }
            try{
                const res = await fetch('/api/auth/change_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,current_password,new_password})});
                const data = await res.json();
                if(res.ok){ ok.textContent='Senha alterada com sucesso. Redirecionando...'; ok.style.display='block'; setTimeout(()=>{ window.location.href='index.html'; },1200); }
                else { err.textContent=data.error||'Erro ao trocar a senha.'; err.style.display='block'; }
            }catch(e){ err.textContent='Erro de conexão.'; err.style.display='block'; }
        }
    </script>
    </head>
<body>
    <div class="card">
        <div class="logo"><img src="logo_vizo.svg" alt="Vizô" onerror="this.style.display='none'"></div>
        <h1>Trocar Senha</h1>
        <p>Defina sua nova senha para continuar usando o Vizô Admin.</p>
        <label for="current">Senha atual</label>
        <input id="current" type="password" placeholder="Senha provisória">
        <label for="new">Nova senha</label>
        <input id="new" type="password" placeholder="Mínimo 8 caracteres">
        <label for="confirm">Confirmar nova senha</label>
        <input id="confirm" type="password" placeholder="Repita a nova senha">
        <button class="btn" onclick="submitChange()">Salvar nova senha</button>
        <div id="err" class="error"></div>
        <div id="ok" class="success"></div>
        <a href="login.html" class="link">Sair</a>
    </div>
</body>
</html>
